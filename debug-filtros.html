<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Filtros de Explorar</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0f0f0f; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .debug-section { background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .error { border-left: 4px solid #e53e3e; }
        .success { border-left: 4px solid #2f855a; }
        .info { border-left: 4px solid #3182ce; }
        button { background: #ff3333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #e62e2e; }
        pre { background: #252525; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .log { background: #0a0a0a; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .filters-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; color: #aaa; }
        .filter-group input, .filter-group select { padding: 8px; border-radius: 4px; border: 1px solid #333; background: #252525; color: #fff; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .server-card { background: #252525; padding: 15px; border-radius: 6px; border: 1px solid #333; }
        .server-name { color: #ff3333; font-weight: bold; margin-bottom: 5px; }
        .server-info { color: #aaa; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Debug Filtros de Explorar</h1>
        <p>Herramienta de diagn√≥stico para los filtros de la secci√≥n Explorar.</p>
        
        <!-- Formulario de Filtros -->
        <div class="debug-section info">
            <h2>üîç Filtros de B√∫squeda</h2>
            <form id="debug-filters-form" class="filters-form">
                <div class="filter-group">
                    <label for="debug-filter-name">Nombre del Servidor</label>
                    <input type="text" id="debug-filter-name" placeholder="Buscar por nombre...">
                </div>
                <div class="filter-group">
                    <label for="debug-filter-version">Versi√≥n</label>
                    <select id="debug-filter-version">
                        <option value="">Todas las versiones</option>
                        <option value="Season 6">Season 6</option>
                        <option value="Season 4">Season 4</option>
                        <option value="Season 2">Season 2</option>
                        <option value="Season 1">Season 1</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="debug-filter-type">Tipo</label>
                    <select id="debug-filter-type">
                        <option value="">Todos los tipos</option>
                        <option value="PvP">PvP</option>
                        <option value="PvM">PvM</option>
                        <option value="Mixto">Mixto</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="debug-filter-configuration">Configuraci√≥n</label>
                    <select id="debug-filter-configuration">
                        <option value="">Todas las configuraciones</option>
                        <option value="Low Rate">Low Rate</option>
                        <option value="Mid Rate">Mid Rate</option>
                        <option value="High Rate">High Rate</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="debug-filter-exp-slider">Experiencia: <span id="debug-exp-value">Cualquiera</span></label>
                    <input type="range" id="debug-filter-exp-slider" min="0" max="17" value="17">
                </div>
                <div class="filter-group">
                    <label for="debug-filter-sort">Ordenar por</label>
                    <select id="debug-filter-sort">
                        <option value="default">Destacados y Votos</option>
                        <option value="newest">M√°s Nuevos</option>
                        <option value="opening_soon">Pr√≥ximas Aperturas</option>
                    </select>
                </div>
            </form>
            <div style="margin-top: 15px;">
                <button onclick="testFilters()">üîç Aplicar Filtros</button>
                <button onclick="resetFilters()">üîÑ Resetear Filtros</button>
                <button onclick="testDirectQuery()">üîå Consulta Directa (Sin Cach√©)</button>
                <button onclick="clearCache()">üóëÔ∏è Limpiar Cach√©</button>
            </div>
        </div>

        <!-- Estado de Filtros -->
        <div class="debug-section info">
            <h2>üìä Estado Actual de Filtros</h2>
            <div id="filters-status"></div>
        </div>

        <!-- Resultados -->
        <div class="debug-section success">
            <h2>üìã Resultados de B√∫squeda</h2>
            <div id="search-results"></div>
            <div id="results-grid" class="results-grid"></div>
        </div>

        <!-- Log de Actividad -->
        <div class="debug-section">
            <h2>üìù Log de Actividad</h2>
            <button onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
            <div id="activity-log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js"></script>
    <script type="module">
        import * as api from './js/modules/api.js';
        import { cache } from './js/modules/cache.js';

        let logContainer;

        function log(message, type = 'info') {
            if (!logContainer) logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f56565' : type === 'success' ? '#48bb78' : '#63b3ed';
            logContainer.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Configurar slider de experiencia
        const expSteps = [1, 5, 10, 20, 50, 100, 150, 200, 250, 300, 400, 500, 750, 1000, 2000, 5000, 9999, 100000];
        function getExpValueFromSlider(sliderValue) { 
            return expSteps[parseInt(sliderValue, 10)]; 
        }

        function initExpSlider() {
            const slider = document.getElementById("debug-filter-exp-slider");
            const expValueEl = document.getElementById("debug-exp-value");
            if (!slider || !expValueEl) return;
            
            const updateExpValue = () => {
                const expValue = getExpValueFromSlider(slider.value);
                expValueEl.textContent = expValue >= 99999 ? "Cualquiera" : `‚â§ ${expValue}x`;
            };
            
            slider.addEventListener("input", updateExpValue);
            updateExpValue();
        }

        function getDebugFilters() {
            return {
                name: document.getElementById("debug-filter-name").value.trim(),
                version: document.getElementById("debug-filter-version").value,
                type: document.getElementById("debug-filter-type").value,
                configuration: document.getElementById("debug-filter-configuration").value,
                exp: getExpValueFromSlider(document.getElementById("debug-filter-exp-slider").value),
                sort: document.getElementById("debug-filter-sort").value,
            };
        }

        window.testFilters = async function() {
            const filtersStatus = document.getElementById('filters-status');
            const searchResults = document.getElementById('search-results');
            const resultsGrid = document.getElementById('results-grid');
            
            try {
                const filters = getDebugFilters();
                
                // Mostrar estado de filtros
                filtersStatus.innerHTML = `
                    <pre>${JSON.stringify(filters, null, 2)}</pre>
                `;
                
                log(`üîç Aplicando filtros: ${JSON.stringify(filters)}`);
                
                // Realizar b√∫squeda
                searchResults.innerHTML = '<div style="color: #63b3ed;">‚è≥ Buscando servidores...</div>';
                resultsGrid.innerHTML = '';
                
                const servers = await api.getExploreServers(filters);
                
                searchResults.innerHTML = `
                    <div style="color: #48bb78;">
                        ‚úÖ B√∫squeda completada: ${servers.length} servidores encontrados
                    </div>
                `;
                
                // Mostrar resultados
                if (servers.length === 0) {
                    resultsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #f56565;">No se encontraron servidores con estos filtros</div>';
                } else {
                    resultsGrid.innerHTML = servers.map(server => `
                        <div class="server-card">
                            <div class="server-name">${server.name}</div>
                            <div class="server-info">
                                <div>Versi√≥n: ${server.version || 'N/A'}</div>
                                <div>Tipo: ${server.type || 'N/A'}</div>
                                <div>Config: ${server.configuration || 'N/A'}</div>
                                <div>EXP: ${server.exp_rate || 'N/A'}x</div>
                            </div>
                        </div>
                    `).join('');
                }
                
                log(`‚úÖ B√∫squeda exitosa: ${servers.length} servidores`, 'success');
                
            } catch (error) {
                searchResults.innerHTML = `<div style="color: #f56565;">‚ùå Error: ${error.message}</div>`;
                log(`‚ùå Error en b√∫squeda: ${error.message}`, 'error');
            }
        };

        window.testDirectQuery = async function() {
            const searchResults = document.getElementById('search-results');
            const resultsGrid = document.getElementById('results-grid');
            
            try {
                const filters = getDebugFilters();
                log(`üîå Consulta directa (sin cach√©): ${JSON.stringify(filters)}`);
                
                searchResults.innerHTML = '<div style="color: #63b3ed;">‚è≥ Consulta directa a Supabase...</div>';
                resultsGrid.innerHTML = '';
                
                // Consulta directa sin cach√©
                let query = window.supabaseClient.from('servers')
                    .select('id, name, image_url, banner_url, version, type, configuration, exp_rate, drop_rate, description, website_url, opening_date')
                    .eq('status', 'aprobado');

                if (filters.name) query = query.ilike('name', `%${filters.name}%`);
                if (filters.version) query = query.eq('version', filters.version);
                if (filters.type) query = query.eq('type', filters.type);
                if (filters.configuration) query = query.eq('configuration', filters.configuration);
                if (filters.exp < 99999) query = query.lte('exp_rate', filters.exp);

                switch (filters.sort) {
                    case 'newest': query = query.order('created_at', { ascending: false }); break;
                    case 'opening_soon': query = query.not('opening_date', 'is', null).gt('opening_date', new Date().toISOString()).order('opening_date', { ascending: true }); break;
                    default: query = query.order('is_featured', { ascending: false }).order('votes_count', { ascending: false, nullsFirst: false }); break;
                }
                
                const { data: servers, error } = await query;
                
                if (error) throw error;
                
                searchResults.innerHTML = `
                    <div style="color: #48bb78;">
                        ‚úÖ Consulta directa completada: ${servers.length} servidores encontrados
                    </div>
                `;
                
                // Mostrar resultados
                if (servers.length === 0) {
                    resultsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #f56565;">No se encontraron servidores con estos filtros</div>';
                } else {
                    resultsGrid.innerHTML = servers.map(server => `
                        <div class="server-card">
                            <div class="server-name">${server.name}</div>
                            <div class="server-info">
                                <div>Versi√≥n: ${server.version || 'N/A'}</div>
                                <div>Tipo: ${server.type || 'N/A'}</div>
                                <div>Config: ${server.configuration || 'N/A'}</div>
                                <div>EXP: ${server.exp_rate || 'N/A'}x</div>
                            </div>
                        </div>
                    `).join('');
                }
                
                log(`‚úÖ Consulta directa exitosa: ${servers.length} servidores`, 'success');
                
            } catch (error) {
                searchResults.innerHTML = `<div style="color: #f56565;">‚ùå Error: ${error.message}</div>`;
                log(`‚ùå Error en consulta directa: ${error.message}`, 'error');
            }
        };

        window.resetFilters = function() {
            document.getElementById('debug-filters-form').reset();
            document.getElementById('debug-filter-exp-slider').dispatchEvent(new Event('input'));
            log('üîÑ Filtros reseteados');
        };

        window.clearCache = function() {
            cache.invalidateServerLists();
            log('üóëÔ∏è Cach√© de listas de servidores limpiado');
        };

        window.clearLog = function() {
            document.getElementById('activity-log').innerHTML = '';
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            initExpSlider();
            log('üöÄ Debug tool de filtros inicializado');
        });
    </script>
</body>
</html>
