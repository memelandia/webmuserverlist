<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema de Cach√©</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0f0f0f; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .success { border-left: 4px solid #2f855a; }
        .info { border-left: 4px solid #3182ce; }
        .warning { border-left: 4px solid #d69e2e; }
        button { background: #ff3333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #e62e2e; }
        button:disabled { background: #666; cursor: not-allowed; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #252525; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #ff3333; }
        .stat-label { color: #aaa; }
        pre { background: #252525; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .log { background: #0a0a0a; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .cache-hit { color: #48bb78; }
        .cache-miss { color: #f56565; }
        .cache-info { color: #63b3ed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Sistema de Cach√© Inteligente</h1>
        <p>Esta p√°gina prueba el nuevo sistema de cach√© implementado en MuServerList.</p>
        
        <!-- Estad√≠sticas del Cach√© -->
        <div class="test-section info">
            <h2>üìä Estad√≠sticas del Cach√©</h2>
            <div class="stats-grid" id="cache-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-entries">-</div>
                    <div class="stat-label">Entradas Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expired-entries">-</div>
                    <div class="stat-label">Entradas Expiradas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cache-size">-</div>
                    <div class="stat-label">Tama√±o (KB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cache-usage">-</div>
                    <div class="stat-label">Uso (%)</div>
                </div>
            </div>
            <button onclick="updateCacheStats()">üîÑ Actualizar Estad√≠sticas</button>
            <button onclick="clearExpiredCache()">üßπ Limpiar Expirados</button>
            <button onclick="clearAllCache()">üóëÔ∏è Limpiar Todo</button>
        </div>

        <!-- Pruebas de Rendimiento -->
        <div class="test-section success">
            <h2>‚ö° Pruebas de Rendimiento</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3>Homepage Data</h3>
                    <button onclick="testHomepageCache()" id="homepage-btn">üè† Probar Homepage</button>
                    <div id="homepage-results"></div>
                </div>
                <div>
                    <h3>Server Details</h3>
                    <input type="number" id="server-id" placeholder="ID del servidor" value="4" style="padding: 8px; margin: 5px; border-radius: 4px; border: 1px solid #333; background: #252525; color: #fff;">
                    <button onclick="testServerCache()" id="server-btn">üñ•Ô∏è Probar Servidor</button>
                    <div id="server-results"></div>
                </div>
            </div>
        </div>

        <!-- Pruebas de Invalidaci√≥n -->
        <div class="test-section warning">
            <h2>üîÑ Pruebas de Invalidaci√≥n</h2>
            <button onclick="invalidateHomepage()">‚ùå Invalidar Homepage</button>
            <button onclick="invalidateServer()">‚ùå Invalidar Servidor</button>
            <button onclick="invalidateServerLists()">‚ùå Invalidar Listas</button>
            <div id="invalidation-results"></div>
        </div>

        <!-- Log de Actividad -->
        <div class="test-section">
            <h2>üìù Log de Actividad</h2>
            <button onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
            <div id="activity-log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js"></script>
    <script type="module">
        import { cache } from './js/modules/cache.js';
        import * as api from './js/modules/api.js';

        // Hacer disponibles globalmente para los botones
        window.cache = cache;
        window.api = api;

        let logContainer;

        function log(message, type = 'info') {
            if (!logContainer) logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'hit' ? 'cache-hit' : type === 'miss' ? 'cache-miss' : 'cache-info';
            logContainer.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        window.updateCacheStats = function() {
            const stats = cache.getStats();
            document.getElementById('total-entries').textContent = stats.totalEntries || 0;
            document.getElementById('expired-entries').textContent = stats.expiredEntries || 0;
            document.getElementById('cache-size').textContent = stats.totalSizeKB || 0;
            document.getElementById('cache-usage').textContent = 
                stats.maxEntries ? Math.round((stats.totalEntries / stats.maxEntries) * 100) : 0;
            
            log(`üìä Estad√≠sticas actualizadas: ${stats.totalEntries} entradas, ${stats.totalSizeKB}KB`);
        };

        window.clearExpiredCache = function() {
            cache.clearExpired();
            log('üßπ Cach√© expirado limpiado');
            updateCacheStats();
        };

        window.clearAllCache = function() {
            cache.clearAll();
            log('üóëÔ∏è Todo el cach√© limpiado');
            updateCacheStats();
        };

        window.testHomepageCache = async function() {
            const btn = document.getElementById('homepage-btn');
            const results = document.getElementById('homepage-results');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Probando...';
            
            try {
                // Primera llamada (deber√≠a ser MISS)
                const start1 = performance.now();
                const data1 = await api.getHomepageData();
                const time1 = (performance.now() - start1).toFixed(2);
                
                // Segunda llamada inmediata (deber√≠a ser HIT)
                const start2 = performance.now();
                const data2 = await api.getHomepageData();
                const time2 = (performance.now() - start2).toFixed(2);
                
                results.innerHTML = `
                    <div style="margin-top: 10px; font-size: 12px;">
                        <div>üîÑ Primera llamada: ${time1}ms (Cache MISS esperado)</div>
                        <div>‚ö° Segunda llamada: ${time2}ms (Cache HIT esperado)</div>
                        <div>üìà Mejora: ${((time1 - time2) / time1 * 100).toFixed(1)}% m√°s r√°pido</div>
                        <div>üìä Servidores destacados: ${data2.featuredServers?.length || 0}</div>
                    </div>
                `;
                
                log(`üè† Homepage test: ${time1}ms ‚Üí ${time2}ms (${((time1 - time2) / time1 * 100).toFixed(1)}% mejora)`);
            } catch (error) {
                results.innerHTML = `<div style="color: #f56565;">‚ùå Error: ${error.message}</div>`;
                log(`‚ùå Error en homepage test: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üè† Probar Homepage';
        };

        window.testServerCache = async function() {
            const serverId = document.getElementById('server-id').value;
            const btn = document.getElementById('server-btn');
            const results = document.getElementById('server-results');
            
            if (!serverId) {
                results.innerHTML = '<div style="color: #f56565;">‚ùå Ingresa un ID de servidor</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Probando...';
            
            try {
                // Primera llamada (deber√≠a ser MISS)
                const start1 = performance.now();
                const data1 = await api.getServerById(serverId);
                const time1 = (performance.now() - start1).toFixed(2);
                
                // Segunda llamada inmediata (deber√≠a ser HIT)
                const start2 = performance.now();
                const data2 = await api.getServerById(serverId);
                const time2 = (performance.now() - start2).toFixed(2);
                
                results.innerHTML = `
                    <div style="margin-top: 10px; font-size: 12px;">
                        <div>üîÑ Primera llamada: ${time1}ms (Cache MISS esperado)</div>
                        <div>‚ö° Segunda llamada: ${time2}ms (Cache HIT esperado)</div>
                        <div>üìà Mejora: ${((time1 - time2) / time1 * 100).toFixed(1)}% m√°s r√°pido</div>
                        <div>üñ•Ô∏è Servidor: ${data2?.name || 'No encontrado'}</div>
                    </div>
                `;
                
                log(`üñ•Ô∏è Server test (ID:${serverId}): ${time1}ms ‚Üí ${time2}ms (${((time1 - time2) / time1 * 100).toFixed(1)}% mejora)`);
            } catch (error) {
                results.innerHTML = `<div style="color: #f56565;">‚ùå Error: ${error.message}</div>`;
                log(`‚ùå Error en server test: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üñ•Ô∏è Probar Servidor';
        };

        window.invalidateHomepage = function() {
            cache.invalidateHomepage();
            log('‚ùå Homepage cache invalidado');
            document.getElementById('invalidation-results').innerHTML = 
                '<div style="color: #f56565;">Homepage cache invalidado - pr√≥xima llamada ser√° MISS</div>';
        };

        window.invalidateServer = function() {
            const serverId = document.getElementById('server-id').value || '4';
            cache.invalidateServer(serverId);
            log(`‚ùå Server cache invalidado (ID: ${serverId})`);
            document.getElementById('invalidation-results').innerHTML = 
                `<div style="color: #f56565;">Server cache invalidado (ID: ${serverId}) - pr√≥xima llamada ser√° MISS</div>`;
        };

        window.invalidateServerLists = function() {
            cache.invalidateServerLists();
            log('‚ùå Server lists cache invalidado');
            document.getElementById('invalidation-results').innerHTML = 
                '<div style="color: #f56565;">Server lists cache invalidado - pr√≥ximas b√∫squedas ser√°n MISS</div>';
        };

        window.clearLog = function() {
            document.getElementById('activity-log').innerHTML = '';
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            updateCacheStats();
            log('üöÄ Sistema de pruebas de cach√© inicializado');
        });
    </script>
</body>
</html>
