<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Soporte WebP</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { padding: 20px; }
        .demo-section { 
            background: var(--bg-light); 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0; 
            border: 1px solid var(--border-color);
        }
        .demo-title { 
            color: var(--primary-color); 
            margin-bottom: 15px; 
            font-size: 1.2em;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-item {
            background: var(--bg-contrast);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            text-align: center;
            padding: 15px;
        }
        .test-image {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 10px 0;
        }
        .stats {
            background: var(--bg-dark);
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: var(--bg-light);
            border-radius: 4px;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        .support-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        .supported {
            background: var(--success-color);
            color: white;
        }
        .not-supported {
            background: var(--warning-color);
            color: white;
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: var(--primary-hover); }
        .results {
            background: var(--bg-dark);
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: var(--success-color); }
        .warning { color: var(--warning-color); }
        .error { color: #f56565; }
        .info { color: #63b3ed; }
    </style>
</head>
<body id="page-test">
    <div class="container">
        <h1>üé® Test Soporte WebP</h1>
        <p>Prueba del sistema de optimizaci√≥n de im√°genes con formato WebP y fallback autom√°tico.</p>

        <!-- Estado del Soporte WebP -->
        <div class="demo-section">
            <div class="demo-title">üîç Detecci√≥n de Soporte WebP</div>
            
            <div style="text-align: center;">
                <div class="support-indicator" id="webp-support-indicator">
                    üîÑ Detectando soporte WebP...
                </div>
                <p id="webp-support-details">Verificando capacidades del navegador...</p>
            </div>
            
            <div class="stats">
                <h3>üìä Informaci√≥n del Navegador</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="browser-name">-</div>
                        <div class="stat-label">Navegador</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="webp-status">-</div>
                        <div class="stat-label">Soporte WebP</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="lazy-loading-status">-</div>
                        <div class="stat-label">Lazy Loading Nativo</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="picture-status">-</div>
                        <div class="stat-label">Elemento Picture</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparaci√≥n de Formatos -->
        <div class="demo-section">
            <div class="demo-title">üì∏ Comparaci√≥n de Formatos de Imagen</div>
            
            <div class="comparison-grid">
                <div class="comparison-item">
                    <h4>üìÑ Imagen JPEG Original</h4>
                    <img src="https://picsum.photos/300/200?random=1" alt="Imagen JPEG" class="test-image" id="jpeg-image">
                    <p><strong>Formato:</strong> JPEG</p>
                    <p><strong>Tama√±o estimado:</strong> <span id="jpeg-size">~45 KB</span></p>
                    <p><strong>Calidad:</strong> Est√°ndar</p>
                </div>
                
                <div class="comparison-item">
                    <h4>üé® Imagen WebP Optimizada</h4>
                    <picture>
                        <source srcset="https://picsum.photos/300/200.webp?random=1" type="image/webp">
                        <img src="https://picsum.photos/300/200?random=1" alt="Imagen WebP" class="test-image" id="webp-image">
                    </picture>
                    <p><strong>Formato:</strong> WebP (con fallback)</p>
                    <p><strong>Tama√±o estimado:</strong> <span id="webp-size">~28 KB</span></p>
                    <p><strong>Calidad:</strong> Superior</p>
                    <div class="support-indicator" id="webp-benefit">
                        üìà ~38% m√°s peque√±o
                    </div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="test-button" onclick="testImageLoading()">üß™ Probar Carga de Im√°genes</button>
                <button class="test-button" onclick="compareFormats()">üìä Comparar Formatos</button>
            </div>
            
            <div class="results" id="image-results"></div>
        </div>

        <!-- Test de Lazy Loading con WebP -->
        <div class="demo-section">
            <div class="demo-title">‚è≥ Lazy Loading con WebP</div>
            
            <p>Estas im√°genes se cargan con lazy loading y formato WebP autom√°tico:</p>
            
            <div class="comparison-grid" id="lazy-webp-grid">
                <!-- Se generar√°n din√°micamente -->
            </div>
            
            <div style="text-align: center;">
                <button class="test-button" onclick="generateLazyWebPImages()">üñºÔ∏è Generar Im√°genes Lazy WebP</button>
                <button class="test-button" onclick="testLazyPerformance()">‚ö° Test de Rendimiento</button>
            </div>
            
            <div class="results" id="lazy-results"></div>
        </div>

        <!-- Estad√≠sticas de Optimizaci√≥n -->
        <div class="demo-section">
            <div class="demo-title">üìà Estad√≠sticas de Optimizaci√≥n</div>
            
            <div class="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="total-images">0</div>
                        <div class="stat-label">Im√°genes Totales</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="webp-images">0</div>
                        <div class="stat-label">Im√°genes WebP</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="fallback-images">0</div>
                        <div class="stat-label">Im√°genes Fallback</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="estimated-savings">0%</div>
                        <div class="stat-label">Ahorro Estimado</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="test-button" onclick="updateStats()">üîÑ Actualizar Estad√≠sticas</button>
                <button class="test-button" onclick="exportReport()">üìÑ Exportar Reporte</button>
            </div>
        </div>

        <!-- Beneficios del WebP -->
        <div class="demo-section">
            <div class="demo-title">üéØ Beneficios del Formato WebP</div>
            
            <div style="margin-top: 20px;">
                <h4>üìà Ventajas del WebP:</h4>
                <ul style="margin-left: 20px; color: var(--text-secondary);">
                    <li>‚úÖ <strong>25-35% m√°s peque√±o</strong> que JPEG con la misma calidad</li>
                    <li>‚úÖ <strong>26% m√°s peque√±o</strong> que PNG sin p√©rdida de calidad</li>
                    <li>‚úÖ <strong>Soporte para transparencia</strong> como PNG</li>
                    <li>‚úÖ <strong>Soporte para animaci√≥n</strong> como GIF</li>
                    <li>‚úÖ <strong>Mejor compresi√≥n</strong> con algoritmos avanzados</li>
                    <li>‚úÖ <strong>Carga m√°s r√°pida</strong> especialmente en m√≥viles</li>
                    <li>‚úÖ <strong>Menor uso de ancho de banda</strong></li>
                    <li>‚úÖ <strong>Mejor experiencia de usuario</strong></li>
                </ul>
                
                <h4 style="margin-top: 20px;">üåê Soporte de Navegadores:</h4>
                <ul style="margin-left: 20px; color: var(--text-secondary);">
                    <li>‚úÖ Chrome 23+</li>
                    <li>‚úÖ Firefox 65+</li>
                    <li>‚úÖ Safari 14+</li>
                    <li>‚úÖ Edge 18+</li>
                    <li>‚úÖ Opera 12.1+</li>
                    <li>‚úÖ Android 4.0+</li>
                    <li>‚úÖ iOS 14+</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js"></script>
    <script type="module">
        import { initWebPSupport, isWebPSupported, getWebPUrl, getWebPStats, createLazyWebPImage } from './js/modules/webp-support.js';
        import { observeImagesInContainer } from './js/modules/lazy-loading.js';

        let testStats = {
            totalImages: 0,
            webpImages: 0,
            fallbackImages: 0,
            estimatedSavings: 0
        };

        function log(container, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '#48bb78',
                warning: '#f6e05e', 
                error: '#f56565',
                info: '#63b3ed'
            };
            const element = document.getElementById(container);
            element.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function detectBrowser() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Otro';
        }

        async function initializeTests() {
            console.log('üé® Inicializando tests de WebP...');
            
            // Detectar navegador
            document.getElementById('browser-name').textContent = detectBrowser();
            
            // Detectar capacidades
            document.getElementById('lazy-loading-status').textContent = 
                'loading' in HTMLImageElement.prototype ? '‚úÖ' : '‚ùå';
            document.getElementById('picture-status').textContent = 
                'HTMLPictureElement' in window ? '‚úÖ' : '‚ùå';
            
            // Inicializar soporte WebP
            const webpSupported = await initWebPSupport();
            
            // Actualizar UI
            const indicator = document.getElementById('webp-support-indicator');
            const details = document.getElementById('webp-support-details');
            const status = document.getElementById('webp-status');
            
            if (webpSupported) {
                indicator.textContent = '‚úÖ WebP Soportado';
                indicator.className = 'support-indicator supported';
                details.textContent = 'Tu navegador soporta el formato WebP. Las im√°genes se optimizar√°n autom√°ticamente.';
                status.textContent = '‚úÖ';
            } else {
                indicator.textContent = '‚ùå WebP No Soportado';
                indicator.className = 'support-indicator not-supported';
                details.textContent = 'Tu navegador no soporta WebP. Se usar√°n formatos tradicionales con fallback autom√°tico.';
                status.textContent = '‚ùå';
            }
        }

        window.testImageLoading = async function() {
            log('image-results', 'üß™ Iniciando test de carga de im√°genes...', 'info');
            
            try {
                // Test imagen JPEG
                const jpegStart = performance.now();
                await loadImage('https://picsum.photos/300/200?random=2');
                const jpegTime = performance.now() - jpegStart;
                log('image-results', `üìÑ JPEG cargado en ${jpegTime.toFixed(2)}ms`, 'info');
                
                // Test imagen WebP (si es soportado)
                if (isWebPSupported()) {
                    const webpStart = performance.now();
                    await loadImage('https://picsum.photos/300/200.webp?random=2');
                    const webpTime = performance.now() - webpStart;
                    log('image-results', `üé® WebP cargado en ${webpTime.toFixed(2)}ms`, 'success');
                    
                    const improvement = ((jpegTime - webpTime) / jpegTime * 100).toFixed(1);
                    log('image-results', `üìà WebP es ${improvement}% m√°s r√°pido`, 'success');
                } else {
                    log('image-results', '‚ö†Ô∏è WebP no soportado, usando fallback JPEG', 'warning');
                }
                
            } catch (error) {
                log('image-results', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.compareFormats = function() {
            log('image-results', 'üìä Comparando formatos de imagen...', 'info');
            
            const formats = [
                { name: 'JPEG', size: 45, quality: 'Est√°ndar' },
                { name: 'PNG', size: 78, quality: 'Alta' },
                { name: 'WebP', size: 28, quality: 'Superior' }
            ];
            
            formats.forEach(format => {
                const savings = format.name === 'WebP' ? 
                    ((formats[0].size - format.size) / formats[0].size * 100).toFixed(1) : 0;
                
                log('image-results', 
                    `${format.name}: ${format.size}KB, ${format.quality}${savings > 0 ? ` (${savings}% m√°s peque√±o)` : ''}`, 
                    format.name === 'WebP' ? 'success' : 'info');
            });
        };

        window.generateLazyWebPImages = function() {
            const grid = document.getElementById('lazy-webp-grid');
            const images = [];
            
            for (let i = 1; i <= 6; i++) {
                images.push(`
                    <div class="comparison-item">
                        <h4>Imagen ${i}</h4>
                        <picture>
                            <source data-srcset="https://picsum.photos/250/150.webp?random=${i + 10}" type="image/webp">
                            <img data-src="https://picsum.photos/250/150?random=${i + 10}" 
                                 alt="Test Image ${i}" 
                                 class="test-image lazy-placeholder"
                                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='150'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3C/svg%3E">
                        </picture>
                        <p>Lazy loading ${isWebPSupported() ? 'con WebP' : 'con fallback'}</p>
                    </div>
                `);
            }
            
            grid.innerHTML = images.join('');
            
            // Activar lazy loading
            observeImagesInContainer(grid);
            
            log('lazy-results', `üñºÔ∏è Generadas 6 im√°genes con lazy loading y ${isWebPSupported() ? 'WebP' : 'fallback'}`, 'success');
        };

        window.testLazyPerformance = async function() {
            log('lazy-results', '‚ö° Iniciando test de rendimiento lazy loading...', 'info');
            
            const metrics = {
                lazyImages: document.querySelectorAll('[data-src]').length,
                loadedImages: document.querySelectorAll('.lazy-loaded').length,
                webpImages: isWebPSupported() ? document.querySelectorAll('source[type="image/webp"]').length : 0
            };
            
            log('lazy-results', `üìä Im√°genes lazy: ${metrics.lazyImages}`, 'info');
            log('lazy-results', `üìä Im√°genes cargadas: ${metrics.loadedImages}`, 'info');
            log('lazy-results', `üìä Im√°genes WebP: ${metrics.webpImages}`, 'success');
            
            const efficiency = metrics.lazyImages > 0 ? 
                (metrics.loadedImages / metrics.lazyImages * 100).toFixed(1) : 0;
            log('lazy-results', `üìà Eficiencia de carga: ${efficiency}%`, 'success');
        };

        window.updateStats = function() {
            const stats = getWebPStats();
            
            document.getElementById('total-images').textContent = stats.totalImages || testStats.totalImages;
            document.getElementById('webp-images').textContent = stats.webpImages || testStats.webpImages;
            document.getElementById('fallback-images').textContent = stats.fallbackImages || testStats.fallbackImages;
            document.getElementById('estimated-savings').textContent = (stats.estimatedSavings || testStats.estimatedSavings) + '%';
            
            // Simular estad√≠sticas si no hay datos reales
            if (stats.totalImages === 0) {
                testStats.totalImages = document.querySelectorAll('img').length;
                testStats.webpImages = isWebPSupported() ? Math.floor(testStats.totalImages * 0.8) : 0;
                testStats.fallbackImages = testStats.totalImages - testStats.webpImages;
                testStats.estimatedSavings = isWebPSupported() ? 32 : 0;
                
                document.getElementById('total-images').textContent = testStats.totalImages;
                document.getElementById('webp-images').textContent = testStats.webpImages;
                document.getElementById('fallback-images').textContent = testStats.fallbackImages;
                document.getElementById('estimated-savings').textContent = testStats.estimatedSavings + '%';
            }
        };

        window.exportReport = function() {
            const report = {
                timestamp: new Date().toISOString(),
                browser: detectBrowser(),
                webpSupported: isWebPSupported(),
                lazyLoadingSupported: 'loading' in HTMLImageElement.prototype,
                pictureSupported: 'HTMLPictureElement' in window,
                stats: getWebPStats(),
                testStats: testStats
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'webp-test-report.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('üìÑ Reporte WebP exportado');
        };

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = resolve;
                img.onerror = reject;
                img.src = src;
            });
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            initializeTests();
            updateStats();
        });
    </script>
</body>
</html>
