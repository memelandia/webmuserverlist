<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test RPC Function</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0f0f0f; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .result { background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .success { border-left: 4px solid #2f855a; }
        .error { border-left: 4px solid #e53e3e; }
        button { background: #ff3333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #e62e2e; }
        pre { background: #252525; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test RPC Function - get_homepage_data</h1>
        <p>Esta p√°gina prueba la nueva funci√≥n RPC optimizada para la homepage.</p>
        
        <button onclick="testRPCFunction()">üöÄ Probar Funci√≥n RPC</button>
        <button onclick="testLegacyFunctions()">üìä Probar Funciones Legacy</button>
        
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js"></script>
    
    <script>
        async function testRPCFunction() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">‚è≥ Probando funci√≥n RPC...</div>';
            
            const startTime = performance.now();
            
            try {
                const { data, error } = await window.supabaseClient.rpc('get_homepage_data');
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                if (error) {
                    throw error;
                }
                
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Funci√≥n RPC Exitosa</h3>
                        <p><strong>Tiempo de respuesta:</strong> ${duration}ms</p>
                        <p><strong>Servidores destacados:</strong> ${data.featuredServers?.length || 0}</p>
                        <p><strong>Servidor del mes:</strong> ${data.serverOfTheMonth ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Top ranking:</strong> ${data.topRanking?.length || 0}</p>
                        <p><strong>Pr√≥ximas aperturas:</strong> ${data.upcomingOpenings?.length || 0}</p>
                        <p><strong>Estad√≠sticas:</strong> ${data.globalStats?.totalServers || 0} servidores, ${data.globalStats?.totalUsers || 0} usuarios, ${data.globalStats?.totalVotes || 0} votos</p>
                        <details>
                            <summary>Ver datos completos</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Error en Funci√≥n RPC</h3>
                        <p><strong>Tiempo transcurrido:</strong> ${duration}ms</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        async function testLegacyFunctions() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">‚è≥ Probando funciones legacy (5 consultas separadas)...</div>';
            
            const startTime = performance.now();
            
            try {
                // Simular las 5 consultas originales
                const [featured, serverOfMonth, ranking, upcoming, stats] = await Promise.all([
                    window.supabaseClient.from('servers')
                        .select('id, name, image_url, banner_url, version, type, configuration, exp_rate, drop_rate, opening_date')
                        .eq('status', 'aprobado')
                        .eq('is_featured', true)
                        .limit(5),
                    window.supabaseClient.from('servers')
                        .select('*')
                        .eq('is_server_of_the_month', true)
                        .maybeSingle(),
                    window.supabaseClient.from('servers')
                        .select('id, name, image_url, votes_count, version, type, exp_rate')
                        .eq('status', 'aprobado')
                        .order('votes_count', { ascending: false, nullsFirst: false })
                        .limit(5),
                    window.supabaseClient.from('servers')
                        .select('id, name, opening_date')
                        .not('opening_date', 'is', null)
                        .gt('opening_date', new Date().toISOString())
                        .order('opening_date', { ascending: true })
                        .limit(3),
                    Promise.all([
                        window.supabaseClient.from('servers').select('*', { count: 'exact', head: true }).eq('status', 'aprobado'),
                        window.supabaseClient.from('profiles').select('*', { count: 'exact', head: true }),
                        window.supabaseClient.from('servers').select('votes_count').eq('status', 'aprobado')
                    ])
                ]);
                
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                // Procesar estad√≠sticas
                const [serverCount, userCount, votesData] = stats;
                const totalVotes = votesData.data ? votesData.data.reduce((acc, s) => acc + (s.votes_count || 0), 0) : 0;
                
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>üìä Funciones Legacy Completadas</h3>
                        <p><strong>Tiempo de respuesta:</strong> ${duration}ms</p>
                        <p><strong>Consultas realizadas:</strong> 8 consultas separadas</p>
                        <p><strong>Servidores destacados:</strong> ${featured.data?.length || 0}</p>
                        <p><strong>Servidor del mes:</strong> ${serverOfMonth.data ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Top ranking:</strong> ${ranking.data?.length || 0}</p>
                        <p><strong>Pr√≥ximas aperturas:</strong> ${upcoming.data?.length || 0}</p>
                        <p><strong>Estad√≠sticas:</strong> ${serverCount.count || 0} servidores, ${userCount.count || 0} usuarios, ${totalVotes} votos</p>
                    </div>
                `;
            } catch (error) {
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Error en Funciones Legacy</h3>
                        <p><strong>Tiempo transcurrido:</strong> ${duration}ms</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
