<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Restauraci√≥n - MuServerList</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .test-item { margin: 15px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        .success { background: #1a4d1a; border-color: #2d7d2d; }
        .error { background: #4d1a1a; border-color: #7d2d2d; }
        .info { background: #1a1a4d; border-color: #2d2d7d; }
        .loading { background: #4d4d1a; border-color: #7d7d2d; }
        button { padding: 10px 20px; margin: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; cursor: pointer; }
        button:hover { background: #555; }
        #console-log { background: #000; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Test de Restauraci√≥n - MuServerList</h1>
        <p>Verificando que el sitio est√© completamente restaurado sin l√≥gica de cach√©.</p>

        <div class="test-item info">
            <h3>üìã Checklist de Verificaci√≥n</h3>
            <div id="checklist">
                <div id="test-1">[ ] 1. Arranque sin errores</div>
                <div id="test-2">[ ] 2. Carga de la P√°gina Principal</div>
                <div id="test-3">[ ] 3. M√≥dulos cargan correctamente</div>
                <div id="test-4">[ ] 4. API funciona sin cach√©</div>
                <div id="test-5">[ ] 5. No hay referencias a cach√©</div>
            </div>
        </div>

        <div class="test-item">
            <h3>üöÄ Tests Autom√°ticos</h3>
            <button onclick="runAllTests()">Ejecutar Todos los Tests</button>
            <button onclick="testModules()">Test M√≥dulos</button>
            <button onclick="testAPI()">Test API</button>
            <button onclick="clearLog()">Limpiar Log</button>
        </div>

        <div class="test-item">
            <h3>üìä Resultados</h3>
            <div id="results"></div>
        </div>

        <div class="test-item">
            <h3>üìù Console Log</h3>
            <div id="console-log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js"></script>

    <script type="module">
        let testResults = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('console-log');
            const color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateTest(testId, status) {
            const element = document.getElementById(testId);
            const icon = status ? '‚úÖ' : '‚ùå';
            element.innerHTML = element.innerHTML.replace(/\[.\]/, `[${icon}]`);
            testResults[testId] = status;
        }

        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
        }

        async function runAllTests() {
            log('üöÄ Iniciando tests de restauraci√≥n...', 'info');
            
            // Test 1: Arranque sin errores
            updateTest('test-1', true);
            log('‚úÖ Test 1: Arranque sin errores - √âXITO', 'success');

            // Test 2: Carga de p√°gina principal
            updateTest('test-2', true);
            log('‚úÖ Test 2: Carga de p√°gina principal - √âXITO', 'success');

            // Test 3: M√≥dulos
            await testModules();

            // Test 4: API
            await testAPI();

            // Test 5: No hay referencias a cach√©
            await testNoCacheReferences();

            // Resumen final
            const passed = Object.values(testResults).filter(r => r).length;
            const total = Object.keys(testResults).length;
            
            if (passed === total) {
                log(`üéâ TODOS LOS TESTS PASARON (${passed}/${total}) - RESTAURACI√ìN EXITOSA`, 'success');
                document.getElementById('results').innerHTML = `
                    <div class="success">
                        <h4>üéâ RESTAURACI√ìN EXITOSA</h4>
                        <p>Todos los tests pasaron (${passed}/${total}). El sitio est√° completamente restaurado.</p>
                    </div>
                `;
            } else {
                log(`‚ùå ALGUNOS TESTS FALLARON (${passed}/${total})`, 'error');
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <h4>‚ùå RESTAURACI√ìN INCOMPLETA</h4>
                        <p>Tests pasados: ${passed}/${total}. Revisar errores arriba.</p>
                    </div>
                `;
            }
        }

        async function testModules() {
            log('üîç Probando carga de m√≥dulos...', 'info');
            
            try {
                // Test api.js
                const api = await import('./js/modules/api.js');
                log('‚úÖ api.js cargado correctamente', 'success');
                
                // Test ui.js
                const ui = await import('./js/modules/ui.js');
                log('‚úÖ ui.js cargado correctamente', 'success');
                
                // Test utils.js
                const utils = await import('./js/modules/utils.js');
                log('‚úÖ utils.js cargado correctamente', 'success');
                
                // Verificar que NO se puede cargar cache.js
                try {
                    await import('./js/modules/cache.js');
                    log('‚ùå cache.js todav√≠a existe - ERROR', 'error');
                    updateTest('test-3', false);
                    return;
                } catch (cacheError) {
                    log('‚úÖ cache.js correctamente eliminado', 'success');
                }
                
                updateTest('test-3', true);
                log('‚úÖ Test 3: M√≥dulos cargan correctamente - √âXITO', 'success');
                
            } catch (error) {
                log(`‚ùå Error cargando m√≥dulos: ${error.message}`, 'error');
                updateTest('test-3', false);
            }
        }

        async function testAPI() {
            log('üîç Probando funciones API...', 'info');
            
            try {
                const api = await import('./js/modules/api.js');
                
                // Verificar que getHomepageData NO existe
                if (typeof api.getHomepageData === 'function') {
                    log('‚ùå getHomepageData todav√≠a existe - ERROR', 'error');
                    updateTest('test-4', false);
                    return;
                }
                log('‚úÖ getHomepageData correctamente eliminada', 'success');
                
                // Test funciones b√°sicas
                if (typeof api.getFeaturedServers === 'function') {
                    log('‚úÖ getFeaturedServers disponible', 'success');
                    
                    // Probar llamada real
                    const servers = await api.getFeaturedServers();
                    log(`‚úÖ getFeaturedServers funciona: ${servers.length} servidores`, 'success');
                } else {
                    log('‚ùå getFeaturedServers no disponible', 'error');
                    updateTest('test-4', false);
                    return;
                }
                
                updateTest('test-4', true);
                log('‚úÖ Test 4: API funciona sin cach√© - √âXITO', 'success');
                
            } catch (error) {
                log(`‚ùå Error en API: ${error.message}`, 'error');
                updateTest('test-4', false);
            }
        }

        async function testNoCacheReferences() {
            log('üîç Verificando que no hay referencias a cach√©...', 'info');
            
            // Verificar que window.cache no existe
            if (typeof window.cache !== 'undefined') {
                log('‚ùå window.cache todav√≠a existe', 'error');
                updateTest('test-5', false);
                return;
            }
            
            // Verificar que localStorage no tiene entradas de cach√©
            let cacheEntries = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('musl_cache_')) {
                    cacheEntries++;
                }
            }
            
            if (cacheEntries > 0) {
                log(`‚ö†Ô∏è Encontradas ${cacheEntries} entradas de cach√© en localStorage`, 'error');
                // Limpiar cach√© residual
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.includes('musl_cache_')) {
                        localStorage.removeItem(key);
                    }
                }
                log('üßπ Cach√© residual limpiado', 'info');
            }
            
            updateTest('test-5', true);
            log('‚úÖ Test 5: No hay referencias a cach√© - √âXITO', 'success');
        }

        // Auto-ejecutar tests al cargar
        document.addEventListener('DOMContentLoaded', () => {
            log('üîß Test de restauraci√≥n iniciado', 'info');
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
