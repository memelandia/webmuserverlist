<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Agregar Servidor - MuServerList</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #0f0f0f; 
            color: #fff; 
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { 
            background: #1a1a1a; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0; 
            border: 1px solid #333;
        }
        .test-title { 
            color: #ff3333; 
            margin-bottom: 15px; 
            font-size: 1.2em;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .status-ok { background: #2d5a2d; }
        .status-error { background: #5a2d2d; }
        .test-button {
            background: #ff3333;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #e62e2e; }
        .log {
            background: #252525;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body id="page-agregar">
    <div class="container">
        <h1>🧪 Test Agregar Servidor - MuServerList</h1>
        <p>Prueba específica del módulo de agregar servidor.</p>

        <!-- Test de Autenticación -->
        <div class="test-section">
            <div class="test-title">🔐 Test de Autenticación</div>
            <div class="status" id="auth-status">🔄 Verificando autenticación...</div>
            <button class="test-button" onclick="testAuth()">🧪 Probar Auth</button>
        </div>

        <!-- Test de Módulo Add-Server -->
        <div class="test-section">
            <div class="test-title">➕ Test de Módulo Add-Server</div>
            <div class="status" id="module-status">🔄 Verificando módulo...</div>
            <button class="test-button" onclick="testModule()">🧪 Probar Módulo</button>
        </div>

        <!-- Test de Funciones API -->
        <div class="test-section">
            <div class="test-title">📡 Test de Funciones API</div>
            <div class="status" id="api-upload-status">🔄 Verificando funciones upload...</div>
            <div class="status" id="api-addserver-status">🔄 Verificando addServer...</div>
            <button class="test-button" onclick="testAPIFunctions()">🧪 Probar API</button>
        </div>

        <!-- Test de Elementos DOM -->
        <div class="test-section">
            <div class="test-title">🎯 Test de Elementos DOM</div>
            <div class="status" id="dom-status">🔄 Verificando elementos...</div>
            <button class="test-button" onclick="testDOM()">🧪 Probar DOM</button>
        </div>

        <!-- Log -->
        <div class="test-section">
            <div class="test-title">📝 Log de Pruebas</div>
            <div class="log" id="test-log"></div>
            <button class="test-button" onclick="clearLog()">🗑️ Limpiar</button>
        </div>
    </div>

    <!-- Elementos DOM simulados para test -->
    <div style="display: none;">
        <div id="auth-required-message" class="hidden"></div>
        <form id="add-server-form" class="hidden"></form>
        <a id="login-link" href="#"></a>
    </div>

    <!-- Scripts básicos -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '#48bb78',
                error: '#f56565',
                warning: '#f6e05e',
                info: '#63b3ed'
            };
            const logElement = document.getElementById('test-log');
            logElement.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.className = success ? 'status status-ok' : 'status status-error';
            element.textContent = (success ? '✅ ' : '❌ ') + message;
        }

        async function testAuth() {
            log('Probando autenticación...', 'info');
            
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase client no disponible');
                }

                const { data: { session } } = await window.supabaseClient.auth.getSession();
                
                if (session) {
                    updateStatus('auth-status', true, `Usuario autenticado: ${session.user.email}`);
                    log(`✅ Usuario autenticado: ${session.user.email}`, 'success');
                } else {
                    updateStatus('auth-status', false, 'Usuario no autenticado');
                    log('⚠️ Usuario no autenticado (esto es normal)', 'warning');
                }
                
                return !!session;
            } catch (error) {
                updateStatus('auth-status', false, `Error: ${error.message}`);
                log(`❌ Error autenticación: ${error.message}`, 'error');
                return false;
            }
        }

        async function testModule() {
            log('Probando módulo add-server...', 'info');

            try {
                const addServerModule = await import('./js/add-server.js');
                
                if (typeof addServerModule.initAddServerPage === 'function') {
                    updateStatus('module-status', true, 'Módulo cargado correctamente');
                    log('✅ add-server.js cargado correctamente', 'success');
                    
                    // Intentar inicializar (puede fallar por DOM pero eso está bien)
                    try {
                        await addServerModule.initAddServerPage();
                        log('✅ initAddServerPage ejecutado sin errores', 'success');
                    } catch (initError) {
                        log(`⚠️ initAddServerPage falló (esperado): ${initError.message}`, 'warning');
                    }
                } else {
                    updateStatus('module-status', false, 'initAddServerPage no encontrada');
                    log('❌ initAddServerPage no es una función', 'error');
                }
            } catch (error) {
                updateStatus('module-status', false, `Error: ${error.message}`);
                log(`❌ Error cargando módulo: ${error.message}`, 'error');
            }
        }

        async function testAPIFunctions() {
            log('Probando funciones de API...', 'info');

            try {
                const api = await import('./js/modules/api.js');
                
                // Test funciones de upload
                const uploadFunctions = ['uploadFile', 'uploadFileRobust', 'uploadFileSimple', 'uploadFileAlternative'];
                let uploadOk = true;
                
                for (const funcName of uploadFunctions) {
                    if (typeof api[funcName] === 'function') {
                        log(`✅ ${funcName} disponible`, 'success');
                    } else {
                        log(`❌ ${funcName} no disponible`, 'error');
                        uploadOk = false;
                    }
                }
                
                updateStatus('api-upload-status', uploadOk, uploadOk ? 'Funciones upload OK' : 'Funciones upload faltantes');
                
                // Test addServer
                if (typeof api.addServer === 'function') {
                    updateStatus('api-addserver-status', true, 'addServer disponible');
                    log('✅ addServer disponible', 'success');
                } else {
                    updateStatus('api-addserver-status', false, 'addServer no disponible');
                    log('❌ addServer no disponible', 'error');
                }
                
            } catch (error) {
                updateStatus('api-upload-status', false, `Error: ${error.message}`);
                updateStatus('api-addserver-status', false, `Error: ${error.message}`);
                log(`❌ Error cargando API: ${error.message}`, 'error');
            }
        }

        function testDOM() {
            log('Probando elementos DOM...', 'info');

            const requiredElements = [
                'auth-required-message',
                'add-server-form', 
                'login-link'
            ];
            
            let allFound = true;
            
            for (const elementId of requiredElements) {
                const element = document.getElementById(elementId);
                if (element) {
                    log(`✅ Elemento ${elementId} encontrado`, 'success');
                } else {
                    log(`❌ Elemento ${elementId} no encontrado`, 'error');
                    allFound = false;
                }
            }
            
            updateStatus('dom-status', allFound, allFound ? 'Todos los elementos encontrados' : 'Elementos faltantes');
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 Test de agregar servidor iniciado', 'info');
            
            // Auto-test después de un momento
            setTimeout(async () => {
                log('🔄 Iniciando tests automáticos...', 'info');
                
                await testAuth();
                await testModule();
                await testAPIFunctions();
                testDOM();
            }, 1000);
        });
    </script>
</body>
</html>
